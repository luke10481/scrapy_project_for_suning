# -*- coding: utf-8 -*-
import scrapy
import re
import requests
from scrapy.http import Request
from selenium import webdriver
from mySpider.items import MyspiderItem


# //*[@id="filter-results"]/ul/li/div/div/div/div/div/a/@href

class SuningSpider(scrapy.Spider):
    name = 'suning'

    def __init__(self):
        self.browser = webdriver.Chrome()
        self.browser.set_page_load_timeout(30)

    '''   
    戴尔
    [['0000000000/139095658', '0000000000/139095658'], ['0070150601/189661028'], ['0070150218/193069489', '0070150218/638100401'], ['0070125607/616986051', '0070113915/617082335'],
                        ['0070144139/10011699913'], ['0070175628/10544142435', '0070175628/10544142435'], ['0070125607/141876878'], ['0070113915/754472913'], ['0070150601/630162260'],
                        ['0070144139/10009782908', '0070144139/10009783923'], ['0070179175/10001866700'], ['0070179175/10000028474'], ['0070115328/10331761823', '0070115328/945033014'],
                        ['0070098310/615609164'], ['0070113915/647252253'], ['0070150601/10178185186', '0070150601/10177312741', '0070113915/10512952028', '0070150601/10175434005'],
                        ['0070113915/754472780'], ['0070113915/754480208', '0070179175/10000029385'], ['0070150601/189472462'], ['0070113915/661956343'], ['0070144139/10026964206'],
                        ['0070144139/10011699771'], ['0070113915/756322671'], ['0070144139/10013753624'], ['0070179175/10000029110'], ['0070125607/608099446'], ['0070179175/10000029058'],
                        ['0070150218/638100399'], ['0070179175/10000029388'], ['0070113915/713963449'], ['0070113915/609179112'], ['0070150218/620031060'], ['0070179175/10000029415'],
                        ['0070150218/193182485'], ['0070113915/10512968596', '0070113915/10529709126', '0070113915/10512968599'], ['0070174045/826306515'], ['0070125607/602587924'],
                        ['0070113915/626019499'], ['0070125607/193244017'], ['0070179175/10001857569'], ['0070179175/10000029387'], ['0070179175/10001857245'], ['0070113915/646330662'],
                        ['0070150601/189747541'], ['0070113915/732691302', '0070179175/10001883816'], ['0070144139/10013758418'], ['0070179175/10000029416'], ['0070113915/617082332'],
                        ['0070179175/10000029393'], ['0070113915/609183824'], ['0070179175/10001866862'], ['0070113915/609183560'], ['0070179175/10000089630'], ['0070150218/189342070']]
    华为
    [['0000000000/10046132753', '0000000000/945027595'],
                        ['0000000000/623778533', '0000000000/623778534', '0000000000/623778543', '0000000000/623778535', '0000000000/945024916', '0000000000/945031128', '0000000000/945031129',
                         '0000000000/945024915', '0000000000/628984863', '0000000000/945031130', '0000000000/628984864'],
                        ['0000000000/10385642717', '0000000000/945031134', '0000000000/10385642768', '0000000000/945031133'],
                        ['0000000000/945031131', '0000000000/945031132'],
                        ['0000000000/623824983', '0000000000/623824988', '0000000000/623824984', '0000000000/623824985'],
                        ['0000000000/623778529', '0000000000/623778532'],
                        ['0000000000/10046046706', '0000000000/945027597']]
    苹果
    [['0000000000/945022108', '0000000000/945022107', '0000000000/945031816'], ['0000000000/627657501']]
    联想
    [['0000000000/703380730'], ['0000000000/620467924', '0070174035/720148608'], ['0000000000/824722747', '0070143293/668179329'], ['0070152181/673578785', '0070152181/673578785'],
                        ['0000000000/10545842123', '0000000000/10545842119', '0070131803/10553992423', '0000000000/945033607', '0000000000/945033608', '0070115328/10558155634'],
                        ['0070080070/832314675', '0070080070/832351494'], ['0000000000/10115078249', '0070152181/627662875'], ['0070143293/656835995'], ['0000000000/10116853161'],
                        ['0000000000/10483971978', '0070174035/10515247683'], ['0070152181/673255831', '0070152181/673255831'], ['0070080070/826162598'], ['0000000000/664310113'],
                        ['0070152181/673389347', '0070152181/673389347'], ['0000000000/861229178'], ['0000000000/694126674'], ['0070073727/690098498', '0070073727/690098520'],
                        ['0000000000/603608954'], ['0070174035/720155095', '0070174035/720167259'], ['0000000000/776289976'], ['0070073727/600042411'],
                        ['0070073727/690098567', '0070115328/688644232', '0070115328/688524440'], ['0000000000/824722773', '0000000000/945026614'], ['0000000000/624690030'], ['0000000000/776258874'],
                        ['0070174035/854326534'], ['0000000000/832262787'], ['0070073727/617622454'], ['0070143293/683754069'], ['0070174035/721172583', '0070174035/732164877'],
                        ['0070073727/623654978'], ['0000000000/10048163041'], ['0070073727/600148735', '0070115328/600245794'], ['0070115328/625265939', '0070174035/732205726'],
                        ['0000000000/774885886'], ['0000000000/827435880', '0000000000/945026613'],
                        ['0070131803/10542873522', '0070131803/10542873525', '0070131803/10542873506', '0070131803/10560952564', '0070146323/10518362887'], ['0000000000/832237416'],
                        ['0070152181/624026243', '0070152181/624026252', '0070131803/624745067'], ['0070174035/732117462'], ['0070143293/618716536'], ['0070172733/716033138'],
                        ['0070143293/626404463'], ['0070174035/721599872', '0070174035/721596781']]
    华硕
    [['0000000000/709393444', '0000000000/709393444', '0070132401/729406288'], ['0000000000/731861078', '0000000000/945033610'], 
                        ['0000000000/10031676622', '0070185004/10511700549'], ['0070207479/10553486522', '0070207479/10553486522'], ['0000000000/767016147', '0000000000/945033614'], 
                        ['0000000000/767016152'], ['0070125607/621081760'], ['0000000000/10450499754', '0000000000/945033613', '0000000000/945033609'], ['0000000000/773987015'], 
                        ['0070125607/624790672', '0070125607/683550886'], ['0000000000/626364066'], ['0000000000/826212171'], ['0070175628/10547103644', '0070175628/10547103644'], 
                        ['0070162598/10551162542', '0070162598/10551163561'], ['0070150218/698059216'], ['0000000000/861275382'], ['0000000000/775648186'], ['0000000000/774043129'], 
                        ['0070175628/10543338393', '0070175628/10543338393'], ['0000000000/709393347'], ['0070174035/773680685', '0070174035/782479091'], ['0070125607/825405471'], 
                        ['0070150218/626052600'], ['0000000000/806376483', '0000000000/945030934', '0000000000/945030828', '0000000000/945033615'], ['0070150218/622127050'], 
                        ['0070174035/10511573799', '0000000000/10466698362', '0000000000/945033612'], ['0000000000/10045429581'], ['0000000000/10465990821'], 
                        ['0000000000/806376559', '0000000000/945033616'], ['0070150601/604714365'], ['0070132401/617557018', '0070150218/621281731'], ['0070150601/180459130', '0070132401/174009177'], 
                        ['0000000000/10465990516'], ['0070175593/773353250'], ['0000000000/10465990651'], ['0070175593/781529172'], ['0000000000/945033611'], 
                        ['0000000000/945020432', '0000000000/945020015'], ['0070150218/654473280', '0070150218/654473270', '0070150218/654435004', '0070150218/654913757'], ['0070125607/624758049'], 
                        ['0070150218/188068595'], ['0070174035/10547789715', '0070175593/773288894'], ['0070150218/622036568'], ['0070150218/624651150'], ['0070150601/180134386'], 
                        ['0070174035/734612733'], ['0070150218/622127492'], ['0070150601/672065980'], ['0070175593/773385633'], ['0070174035/773680698'], ['0070175593/792682658']]
    三星
    [['0000000000/658525943'],
                        ['0070174045/801653902', '0070174045/801653860', '0070174045/801653912'],
                        ['0070174045/826300925', '0000000000/782161146'],
                        ['0070174045/826133019', '0070174045/826133018'],
                        ['0070174045/729323005', '0070174045/729313367'],
                        ['0000000000/615295049'],
                        ['0000000000/945027833'],
                        ['0000000000/945027832'],
                        ['0070174045/729343621', '0070174045/729333380', '0070174045/728513728'],
                        ['0000000000/615295072']]
    惠普
    [['0000000000/10543336283'],
                        ['0000000000/623899543', '0000000000/623899543', '0000000000/945029246'],
                        ['0000000000/624028667', '0000000000/624028667'],
                        ['0000000000/10529864711'],
                        ['0000000000/674470698'],
                        ['0000000000/10529864744'],
                        ['0000000000/10529864685'],
                        ['0000000000/626340384', '0000000000/626340384'],
                        ['0000000000/626266187'],
                        ['0000000000/674476716'],
                        ['0000000000/10543336284'],
                        ['0000000000/673757024'],
                        ['0000000000/10529864699'],
                        ['0000000000/674476709'],
                        ['0000000000/626340385'],
                        ['0000000000/626340383'],
                        ['0070113915/600208837'],
                        ['0070094154/628064124']]
    小米
    [['0000000000/697728575', '0000000000/945022546'],
                        ['0000000000/10057213973', '0000000000/10057302391'],
                        ['0000000000/628920339'],
                        ['0000000000/10057572887'],
                        ['0000000000/697728557', '0000000000/945022548'],
                        ['0000000000/10169254614'],
                        ['0000000000/945033634', '0000000000/945033635', '0000000000/945033633', '0000000000/945033632'],
                        ['0000000000/945022545']]
    雷神
    [['0000000000/10539620241'],
                        ['0000000000/945033618'],
                        ['0000000000/945033617'],
                        ['0000000000/761598805'],
                        ['0000000000/678402099'],
                        ['0000000000/635719012'],
                        ['0000000000/695031484'],
                        ['0000000000/600141572'],
                        ['0000000000/635719011']]
    神舟
    [['0070115156/600410225'], 
    ['0070132529/184855360', '0070132529/184855360'], 
    ['0070115156/141554538']]

    thinkpad
    [['0070085193/136307933'], 
    ['0000000000/688475990'], 
    ['0000000000/187664495'], 
    ['0000000000/178409571'], 
    ['0070113915/10059833589'], 
    ['0000000000/616393265'], 
    ['0070113915/143259238'], 
    ['0070113915/624428680'], 
    ['0070085193/621835173', '0070113915/152218771'], 
    ['0070113915/10059833572'], 
    ['0070113915/190361294'], 
    ['0070113915/10264413076'], 
    ['0070113915/10460190556'], 
    ['0070113915/661632321'], 
    ['0070113915/170411527'], 
    ['0070113915/630475218'], 
    ['0070113915/696012086'], 
    ['0070113915/178584953'], 
    ['0070113915/683721085']]

    未来人类
    [['0000000000/945033776'], ['0000000000/688453192', '0000000000/945022964']]

    微星
    [['0000000000/718894651', '0000000000/718894651'], ['0000000000/945033623']]

    海尔
    [['0000000000/782785713'], ['0000000000/774910736'], ['0000000000/129513425'], ['0000000000/170108213'], ['0000000000/651714492']]
    '''

    def start_requests(self):
        product_list = [['0000000000/782785713'], ['0000000000/10440146550'], ['0000000000/774910736'], ['0000000000/10538704638'], ['0000000000/623402250'], ['0000000000/774910735'], ['0000000000/651716328']]
        for products in product_list:
            parentId = products[0].split('/')  # 同一个列表里边默认第一个为父
            for itemId in products:
                itemId = itemId.split('/')
                url = 'https://product.suning.com/{}.html'.format('/'.join(itemId))
                yield Request(url=url, meta={'itemId': itemId, 'parentId': parentId}, callback=self.parse)

    def parse(self, response):
        itemId = response.meta['itemId']
        parentId = response.meta['parentId']
        # 品牌
        name = response.xpath('//*[@parametercode="009177"]/..//*[@parametercode="000897"]/td[2]//text()').extract()[0]
        # 商品名字
        skuName = response.xpath('//*[@parametercode="009177"]/..//*[@parametercode="005039"]/td[2]/text()').extract()[
            0]
        # 价格
        url = "https://icps.suning.com/icps-web/getVarnishAllPrice014/{}_769_7690001_{}_1_getClusterPrice.vhtm?callback=getClusterPrice".format(
            '{:0>18}'.format(itemId[1]), itemId[0])
        price = re.compile('"price":"(.*?)"').findall(requests.get(url).text)[0]

        # 相对属性
        property_key = response.xpath('//*[@parametercode!=999998]/td[1]/div/span/text()').extract()
        property_value = response.xpath('//*[@parametercode!=999998]/td[2]//text()').extract()
        property_len = len(property_key)
        property_str = ''
        for i in range(property_len):
            property_str += property_key[i] + ',' + property_value[i] + '\n'
        # item['property'] = property_str

        # 图片
        imgURL_list = response.xpath('//*[@id="imgZoom"]/div/div/ul/li/a/img/@src').extract()
        n = len(imgURL_list)
        for i in range(n):
            imgURL_list[i] = 'http:' + imgURL_list[i]
        # item['img_src'] = img_str

        # 评论
        comments = []
        sum = []
        # 页数
        fronturl = 'review_lists/general-'
        judgeUrl = "https://review.suning.com/ajax/{}-{}-{}-{}-1-default-10-----reviewList.htm?callback=reviewList".format(
            fronturl,'{:0>18}'.format(itemId[1]), itemId[0], 'good')
        str = requests.get(judgeUrl).text
        if '"commodityReviews":[]' in str:
            fronturl = 'cluster_review_lists/package-'
        judgeUrl = "https://review.suning.com/ajax/{}-{}-{}-{}-1-default-10-----reviewList.htm?callback=reviewList".format(
            fronturl, '{:0>18}'.format(itemId[1]), itemId[0], 'good')
        str = requests.get(judgeUrl).text
        if '"commodityReviews":[]' in str:
            fronturl = 'review_lists/general'
        for i in range(1, 51):
            commUrl = "https://review.suning.com/ajax/{}-{}-{}-{}-{}-default-10-----reviewList.htm?callback=reviewList".format(
                fronturl, '{:0>18}'.format(itemId[1]), itemId[0], 'good', i)
            yield Request(url=commUrl, meta={'itemId': itemId, 'parentId': parentId, 'name': name, 'skuName': skuName,
                                             'price': price, 'property_str': property_str, 'imgURL_list': imgURL_list,
                                             'comments': comments, 'sum': sum}, callback=self.comm)

    def comm(self, response):
        comment_content = re.compile(
            '{"bestTag":.*?,"commodityReviewId":(.*?),"content":"(.*?)","publishTime":"(.*?)".*?"nickName":"(.*?)".*?"qualityStar":(.*?),.*?"usefulCnt":(.*?),.*?"returnMsg":.*?}').findall(
            response.text)
        comments = response.meta['comments']
        comments.extend(comment_content)
        sum = response.meta['sum']
        sum.append(0)
        # 跳出
        if (len(sum) == 50):
            item = MyspiderItem()
            item['itemId'] = response.meta['itemId'][1]
            item['parentId'] = response.meta['parentId'][1]
            item['name'] = re.sub('\((.*?)\)$', '', response.meta['name'])
            item['skuName'] = response.meta['skuName']
            item['price'] = response.meta['price']
            item['property'] = response.meta['property_str']
            item['img_src'] = response.meta['imgURL_list']
            item['comment_list'] = comments
            del sum
            yield item